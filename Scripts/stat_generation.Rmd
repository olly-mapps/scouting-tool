---
title: "Sandbox"
output: html_notebook
author: "olly-mapps"
---

Contained in this notebook is the sandbox for code that I plan to use for a football scouting tool 


# Libraries
```{r}
library(tidyverse)
library(worldfootballR)
```

# Data Loading

We first define stat types to extract from worldsoccerR

```{r}
#Define stat types
stat_types = c("standard", "shooting", "passing", "passing_types", "gca", "defense", "possession", "playing_time", "misc", "keepers", "keepers_adv")
```

We next define a loop to extract these data based on the stat type

```{r}
#Define loop to iterate through the stat types
for (type in stat_types){
  
  #Load the data for the specific type
  temp <- data.frame(load_fb_big5_advanced_season_stats(stat_type = type, 
                                             team_or_player = "player"))
  #Print type to assess progress
  print(type)
  
  #Assign the data a suitable name
  assign(paste(type, "_stats", sep = ""), get("temp"))
}
```

There are numeric columns that we don't need, so we drop them here. We also drop na values and convert the date to character for later

```{r}
#Define columns to leave out 
not_columns <- c("Age", "Born", "Prog", "A_minus_xA", "xAG", "A_minus_xAG", "PrgP")

type_list_raw <- list(standard_stats, shooting_stats, passing_stats, passing_types_stats, gca_stats, defense_stats, possession_stats, playing_time_stats, misc_stats, keepers_stats, keepers_adv_stats)

type_list <- lapply(type_list_raw, function(x) x %>% 
                      dplyr::select(-any_of(not_columns)) %>% 
                      na.omit(.))


type_list <- setNames(type_list, stat_types)
```

# Converting to Stats

We next convert each column of each data-frame to percentiles, which we can imagine as standardized
'attributes'

```{r}
for (type in stat_types){
  for (col in colnames(dplyr::select(type_list[[type]], where(is.numeric), -Season_End_Year))){
    type_list[[type]][col] <- round(cume_dist(type_list[[type]][col])*100)
  }
}
```

# Finding Transfers 

```{r}
test <- type_list[["passing"]]
test
```

```{r}
transferred_player <-  test %>% 
                        group_by(Player) %>% 
                        dplyr::filter(n_distinct(Squad) > 1) %>% 
                        ungroup()

transferred_player
```

```{r}
messi <- transferred_player %>% dplyr::filter(transferred_player["Player"] == "Aaron Ramsdale")
messi
```

We wish to find averages of the statistics at each club, which we can then use to calculate the differences between leagues

```{r}
#First we calculate averages across each team the player has played for
messi <- messi %>% group_by(Squad, Player, Comp) %>% 
          summarise(across(where(is.double), mean),
                    .groups = 'drop')

messi 
```

```{r}
transfer_gen <- function(x) {
  
  squad_changes <- data.frame()
  
  for(i in 1:(nrow(x)-1)){
    temp <- x[i:(i+1), ]
    temp <- temp %>% dplyr::select(!where(is.double)) %>% 
              rownames_to_column(var = "id") %>%
              pivot_wider(names_from = id, values_from = !id)
    temp <- temp %>% mutate(Player = coalesce(Player_1, Player_2))
    temp <- temp %>% dplyr::select(-c("Player_1", "Player_2"))
    squad_changes <- rbind(squad_changes, temp)
  }
  
  stat_changes <- data.frame(diff(as.matrix(dplyr::select(x, where(is.numeric))), lag = 1))
  
  to_return <- data.frame(squad_changes, stat_changes)
  
  return(to_return)
}

transfer_gen(messi)
```

```{r}
transfers <- transferred_player %>% group_by(Player, Squad, Comp) %>% 
                        summarise(across(where(is.numeric), mean),
                          .groups = 'drop')
```

```{r}

```

```{r}
transfer_changes <- data.frame()

transferred_player_list <- as.list(unique(transfers["Player"]))

transferred_player_list$Player[1]
```

```{r}
for (player in transferred_player_list$Player){
  player_info <- transfers %>% dplyr::filter(transfers["Player"] == player)
  transfer_changes <- rbind(transfer_changes, transfer_gen(player_info))
  print(player)
}

```

```{r}
transfer_changes
```

#Write to csv

We finally write or dataframes to .csv files

```{r}
write.csv(player_standard, "../Data/standard_stats.csv")
write.csv(player_shooting, "../Data/shooting_stats.csv")
write.csv(player_passing, "../Data/passing_stats.csv")
write.csv(player_gca, "../Data/gca_stats.csv")
write.csv(player_defense, "../Data/defense_stats.csv")
write.csv(player_possession, "../Data/possession_stats.csv")
write.csv(player_playing_time, "../Data/playing_time_stats.csv")
write.csv(player_misc, "../Data/misc_stats.csv")
write.csv(player_keepers, "../Data/keepers_stats.csv")
write.csv(player_keepers_adv, "../Data/keepers_adv_stats.csv")
```

